<p-toast></p-toast>

<!-- Success Overlay -->
<div class="success-overlay" *ngIf="paymentSuccess">
  <div class="success-content">
    <i class="pi pi-check-circle"></i>
    <h2>Registration Complete!</h2>
    <p>Thank you for registering for the NorCal Men's Retreat 2026.</p>
    <p>A confirmation email has been sent to <strong>{{ registrationForm.value.email }}</strong>.</p>
    <div class="success-details">
      <div><i class="pi pi-users"></i> {{ attendees.length }} attendee(s)</div>
      <div><i class="pi pi-dollar"></i> ${{ totalCost }} paid</div>
      <div><i class="pi pi-calendar"></i> June 11-13, 2026</div>
    </div>
    <a routerLink="/">
      <button pButton label="Return Home" icon="pi pi-home" class="mt-3"></button>
    </a>
  </div>
</div>

<div class="registration-container" *ngIf="!paymentSuccess">
  <div class="header-section">
    <h1>Men's Retreat Registration</h1>
    <p>June 11-13, 2026 | Alliance Redwoods, Occidental, CA | $288/person</p>
  </div>

  <p-card>
    <ng-template pTemplate="header">
      <div class="card-header-bar"><i class="pi pi-user"></i><span>Primary Contact Information</span></div>
    </ng-template>
    <div class="form-grid" [formGroup]="registrationForm">
      <div class="field"><label>First Name *</label><input type="text" pInputText formControlName="firstName" class="w-full" /></div>
      <div class="field"><label>Last Name *</label><input type="text" pInputText formControlName="lastName" class="w-full" /></div>
      <div class="field"><label>Email *</label><input type="email" pInputText formControlName="email" class="w-full" /></div>
      <div class="field"><label>Phone *</label><input type="tel" pInputText formControlName="phone" class="w-full" /></div>
      <div class="field"><label>Address *</label><input type="text" pInputText formControlName="address" class="w-full" /></div>
      <div class="field"><label>City *</label><input type="text" pInputText formControlName="city" class="w-full" /></div>
      <div class="field"><label>State *</label><input type="text" pInputText formControlName="state" class="w-full" /></div>
      <div class="field"><label>Zip Code *</label><input type="text" pInputText formControlName="zipCode" class="w-full" /></div>
    </div>
  </p-card>

  <p-card>
    <ng-template pTemplate="header">
      <div class="card-header-bar"><i class="pi pi-users"></i><span>Attendees ($288 per person)</span></div>
    </ng-template>
    <div class="attendee-form" [formGroup]="attendeeForm">
      <div class="form-grid">
        <div class="field"><label>First Name *</label><input type="text" pInputText formControlName="firstName" class="w-full" /></div>
        <div class="field"><label>Last Name *</label><input type="text" pInputText formControlName="lastName" class="w-full" /></div>
        <div class="field"><label>Age *</label><input type="number" pInputText formControlName="age" class="w-full" min="18" /></div>
        <div class="field"><label>Dietary Restrictions</label><p-dropdown [options]="dietaryOptions" formControlName="dietaryRestrictions" styleClass="w-full"></p-dropdown></div>
      </div>
      <button pButton label="Add Attendee" icon="pi pi-plus" class="p-button-outlined mt-2" (click)="addAttendee()"></button>
    </div>
    <p-table [value]="attendees" *ngIf="attendees.length > 0" class="mt-3" [tableStyle]="{'min-width': '50rem'}">
      <ng-template pTemplate="header"><tr><th>Name</th><th>Age</th><th>Dietary</th><th style="width: 80px"></th></tr></ng-template>
      <ng-template pTemplate="body" let-attendee let-i="rowIndex">
        <tr>
          <td>{{ attendee.firstName }} {{ attendee.lastName }}</td>
          <td>{{ attendee.age }}</td>
          <td>{{ attendee.dietaryRestrictions }}</td>
          <td><button pButton icon="pi pi-trash" class="p-button-danger p-button-text p-button-sm" (click)="removeAttendee(i)"></button></td>
        </tr>
      </ng-template>
    </p-table>
    <div class="total-section" *ngIf="attendees.length > 0">
      <strong>{{ attendees.length }} attendee(s)</strong> &mdash; Total: <strong>${{ totalCost }}</strong>
    </div>
  </p-card>

  <p-card>
    <ng-template pTemplate="header">
      <div class="card-header-bar"><i class="pi pi-home"></i><span>Accommodation Preference</span></div>
    </ng-template>
    <div [formGroup]="registrationForm">
      <div class="field"><label>Room Preference</label><p-dropdown [options]="roomPreferences" formControlName="roomPreference" styleClass="w-full"></p-dropdown></div>
    </div>
  </p-card>

  <p-card>
    <ng-template pTemplate="header">
      <div class="card-header-bar"><i class="pi pi-exclamation-triangle"></i><span>Emergency Contact</span></div>
    </ng-template>
    <div class="form-grid" [formGroup]="registrationForm">
      <div class="field"><label>Contact Name *</label><input type="text" pInputText formControlName="emergencyName" class="w-full" /></div>
      <div class="field"><label>Relationship *</label><input type="text" pInputText formControlName="emergencyRelationship" class="w-full" /></div>
      <div class="field"><label>Phone *</label><input type="tel" pInputText formControlName="emergencyPhone" class="w-full" /></div>
    </div>
  </p-card>

  <p-card>
    <ng-template pTemplate="header">
      <div class="card-header-bar"><i class="pi pi-star"></i><span>What to Expect</span></div>
    </ng-template>
    <div class="what-to-expect">
      <p>Join us for a transformative weekend in the heart of the California redwoods. Here's what you can look forward to:</p>
      <ul>
        <li><i class="pi pi-users"></i> <strong>Fellowship &amp; Brotherhood</strong> &mdash; Connect with men from across Northern California in a relaxed, welcoming environment.</li>
        <li><i class="pi pi-book"></i> <strong>Inspiring Sessions</strong> &mdash; Engaging speakers and breakout sessions designed to challenge and encourage you.</li>
        <li><i class="pi pi-sun"></i> <strong>Outdoor Activities</strong> &mdash; Hiking trails, campfire gatherings, and time to enjoy the beauty of Alliance Redwoods.</li>
        <li><i class="pi pi-heart"></i> <strong>Worship &amp; Reflection</strong> &mdash; Dedicated times of worship, prayer, and personal reflection throughout the weekend.</li>
        <li><i class="pi pi-building"></i> <strong>Comfortable Lodging</strong> &mdash; Cabin-style accommodations with meals included for the entire weekend.</li>
      </ul>
    </div>
  </p-card>

  <!-- Payment & Submit section (shown only when registration is open) -->
  <ng-container *ngIf="registrationOpen">
    <p-card>
      <ng-template pTemplate="header">
        <div class="card-header-bar"><i class="pi pi-credit-card"></i><span>Payment Details</span></div>
      </ng-template>
      <div class="payment-summary" *ngIf="attendees.length > 0">
        <div class="summary-row">
          <span>{{ attendees.length }} attendee(s) x $288</span>
          <strong>${{ totalCost }}</strong>
        </div>
        <div class="summary-divider"></div>
        <div class="summary-row summary-total">
          <span>Total Due</span>
          <strong>${{ totalCost }}</strong>
        </div>
      </div>
      <div class="stripe-card-wrapper">
        <label class="card-label">Card Details *</label>
        <div id="card-element" class="stripe-card-element"></div>
        <div class="card-error" *ngIf="cardError">{{ cardError }}</div>
      </div>
      <div class="secure-badge">
        <i class="pi pi-lock"></i>
        <span>Secured by Stripe. Your card details are never stored on our servers.</span>
      </div>
    </p-card>

    <p-card>
      <ng-template pTemplate="header">
        <div class="card-header-bar"><i class="pi pi-check-circle"></i><span>Final Details & Submit</span></div>
      </ng-template>
      <div [formGroup]="registrationForm">
        <div class="field"><label>Special Requests or Notes</label>
          <textarea pInputTextarea formControlName="specialRequests" rows="4" class="w-full"
                    placeholder="Any special accommodations, dietary notes, or other requests..."></textarea>
        </div>
      </div>
      <div class="terms-section">
        <p-checkbox [(ngModel)]="agreedToTerms" [binary]="true" inputId="terms"></p-checkbox>
        <label for="terms" class="terms-label">
          I agree to the retreat terms and conditions. I understand the cost is $288 per attendee
          and is non-refundable after May 28, 2026.
        </label>
      </div>
      <button pButton [label]="attendees.length > 0 ? 'Register & Pay $' + totalCost : 'Register & Pay'"
              icon="pi pi-lock" class="w-full mt-3"
              size="large" [loading]="isSubmitting"
              [disabled]="!agreedToTerms || attendees.length === 0 || !cardComplete"
              (click)="submitRegistration()"></button>
    </p-card>
  </ng-container>

  <!-- Registration not yet open banner -->
  <div class="registration-closed-banner" *ngIf="!registrationOpen">
    <i class="pi pi-calendar"></i>
    <h3>Registration Opens March 1, 2026</h3>
    <p>We're excited to have you join us! Registration and payment will be available starting March 1, 2026. Check back soon!</p>
  </div>
</div>
